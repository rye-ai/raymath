<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Kingdom Adventure</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        /*
        * Game: Math Kingdom Adventure
        * Description: A single-file educational game for 4th graders focusing on addition and subtraction word problems.
        * Features: Super Mario theme, avatar upload, localStorage persistence, secret code collection, and randomized prizes.
        *
        * JSON SCHEMA DRIVING THE GAME:
        * {
        * player: { explorerName, avatar, superMushrooms, superStars, solvedPuzzles, currentPuzzleIndex, codeJournal },
        * gameConfig: { totalPuzzles, maxMushrooms },
        * puzzles: [ { id, type, prompt, visual, data, correct, hint } ],
        * prizes: [ "Prize 1", "Prize 2", ... ],
        * sfx: { click, correct, incorrect, win }
        * }
        */

        :root {
            --font-display: 'Press Start 2P', cursive;
            --font-body: 'Fredoka One', cursive;
            --c-blue: #5c94fc;
            --c-green: #42b842;
            --c-yellow: #fbd000;
            --c-red: #ff3e3e;
            --c-brown: #8f563b;
            --c-white: #ffffff;
            --c-black: #000000;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--c-blue);
            color: var(--c-black);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            overflow: hidden;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .game-container {
            width: 100%;
            max-width: 1200px;
            height: 95vh;
            max-height: 800px;
            background-color: var(--c-white);
            border: 6px solid var(--c-black);
            border-radius: 20px;
            box-shadow: 0 8px 0 var(--c-black), 0 15px 20px rgba(0,0,0,0.3);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* --- SCREEN MANAGEMENT --- */
        .screen {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
            animation: fadeIn 0.4s ease;
        }
        .screen.active { display: flex; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            80% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }

        /* --- UI COMPONENTS --- */
        .pixel-button {
            font-family: var(--font-display);
            font-size: 1rem;
            padding: 12px 24px;
            border-radius: 8px;
            border: 4px solid var(--c-black);
            background-color: var(--c-green);
            color: var(--c-white);
            text-shadow: 2px 2px 0 var(--c-black);
            box-shadow: 0 5px 0 var(--c-black);
            cursor: pointer;
            transition: all 0.1s ease-out;
            text-align: center;
        }
        .pixel-button:hover {
            transform: translateY(2px);
            box-shadow: 0 3px 0 var(--c-black);
        }
        .pixel-button:active {
            transform: translateY(5px);
            box-shadow: 0 0px 0 var(--c-black);
        }
        .pixel-button.yellow { background-color: var(--c-yellow); }
        .pixel-button:disabled {
            background-color: #999;
            cursor: not-allowed;
            transform: translateY(0);
            box-shadow: 0 5px 0 var(--c-black);
            opacity: 0.7;
        }

        input[type="text"], input[type="number"] {
            font-family: var(--font-body);
            font-size: 1.2rem;
            padding: 10px 15px;
            border: 4px solid var(--c-black);
            border-radius: 8px;
            text-align: center;
            width: 100%;
        }

        .title {
            font-family: var(--font-display);
            font-size: clamp(1.5rem, 5vw, 2.5rem);
            text-align: center;
            margin-bottom: 2rem;
            color: var(--c-blue);
            text-shadow: 3px 3px 0 var(--c-black);
        }

        /* --- START SCREEN --- */
        #start-screen {
            justify-content: center;
            align-items: center;
            gap: 1.5rem;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 12px;
        }
        #start-screen-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            max-width: 400px;
        }
        #avatar-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid var(--c-black);
            background-color: #eee;
            object-fit: cover;
            box-shadow: 0 4px 0 var(--c-black);
        }
        #avatar-label {
             font-family: var(--font-body);
             font-size: 1rem;
             padding: 8px 16px;
             border-radius: 8px;
             border: 3px solid var(--c-black);
             background-color: var(--c-blue);
             color: var(--c-white);
             text-shadow: 1px 1px 0 var(--c-black);
             box-shadow: 0 4px 0 var(--c-black);
             cursor: pointer;
             transition: all 0.1s ease-out;
        }
         #avatar-label:hover {
            transform: translateY(1px);
            box-shadow: 0 3px 0 var(--c-black);
        }

        /* --- GAME SCREEN --- */
        #game-screen { gap: 1rem; }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--c-brown);
            padding: 0.5rem 1rem;
            border-radius: 12px;
            border: 4px solid var(--c-black);
            flex-shrink: 0;
        }
        .player-info { display: flex; align-items: center; gap: 1rem; }
        #player-avatar-display {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid var(--c-black);
            object-fit: cover;
        }
        #player-name-display {
            font-size: 1.2rem;
            color: var(--c-white);
            text-shadow: 2px 2px 0 var(--c-black);
        }
        .stats-display { display: flex; align-items: center; gap: 1.5rem; }
        .stat { display: flex; align-items: center; gap: 0.5rem; color: var(--c-white); text-shadow: 2px 2px 0 var(--c-black); }
        .stat svg { width: 32px; height: 32px; }
        .stat-count { font-family: var(--font-display); font-size: 1.2rem; }
        
        #hint-btn {
            background: none; border: none; padding: 0; cursor: pointer;
        }
        #hint-btn svg { transition: transform 0.2s ease; }
        #hint-btn:hover svg { transform: scale(1.1); }
        #hint-btn:disabled { cursor: not-allowed; }
        #hint-btn:disabled svg { filter: grayscale(100%); }

        #world-map-container {
            flex-grow: 1;
            background-color: var(--c-green);
            border: 4px solid var(--c-black);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background-image: linear-gradient(rgba(255,255,255,0.2) 50%, transparent 50%);
            background-size: 100% 10px;
        }
        #world-map-path {
            display: flex;
            align-items: center;
            justify-content: space-around;
            width: 95%;
            position: relative;
        }
        .path-line {
            position: absolute;
            height: 8px;
            background-color: var(--c-brown);
            border: 2px solid var(--c-black);
            width: 100%;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1;
        }
        .stage {
            width: 60px;
            height: 60px;
            background-color: #ccc;
            border: 4px solid var(--c-black);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: var(--font-display);
            font-size: 1.5rem;
            color: var(--c-white);
            text-shadow: 2px 2px 0 var(--c-black);
            cursor: not-allowed;
            position: relative;
            z-index: 2;
            box-shadow: 0 4px 0 var(--c-black);
        }
        .stage.unlocked { background-color: var(--c-yellow); cursor: pointer; }
        .stage.completed { background-color: var(--c-green); cursor: default; }
        .stage.completed::after {
            content: 'âœ”';
            position: absolute;
            top: -10px;
            right: -10px;
            color: var(--c-green);
            background: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            line-height: 25px;
            text-align: center;
            border: 2px solid black;
            font-size: 1rem;
            text-shadow: none;
        }
        #player-map-avatar {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid var(--c-black);
            z-index: 3;
            transition: all 0.5s ease-in-out;
            object-fit: cover;
        }

        /* --- QUESTION MODAL --- */
        #question-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        #question-modal {
            background-color: var(--c-white);
            padding: 2rem;
            border-radius: 15px;
            border: 5px solid var(--c-black);
            box-shadow: 0 6px 0 var(--c-black);
            width: 90%;
            max-width: 600px;
            text-align: center;
            animation: popIn 0.3s ease-out;
        }
        #question-modal h2 {
            font-family: var(--font-display);
            margin-bottom: 1rem;
            color: var(--c-blue);
        }
        #question-prompt {
            font-size: 1.3rem;
            line-height: 1.5;
            margin-bottom: 1.5rem;
            min-height: 100px;
        }
        #question-prompt .highlight {
            background-color: var(--c-yellow);
            padding: 2px 4px;
            border-radius: 4px;
        }
        #answer-input { margin-bottom: 1.5rem; max-width: 200px; display: block; margin-left: auto; margin-right: auto; }
        #question-feedback {
            min-height: 30px;
            margin-top: 1rem;
            font-size: 1.2rem;
            font-weight: bold;
        }
        #question-feedback.correct { color: var(--c-green); }
        #question-feedback.incorrect { color: var(--c-red); }
        .feedback-code {
            font-family: var(--font-display);
            font-size: 3rem;
            color: var(--c-blue);
            text-shadow: 3px 3px 0 var(--c-black);
            display: block;
            margin: 1rem 0;
        }

        /* --- VAULT & WIN SCREEN --- */
        #vault-screen, #win-screen {
            justify-content: center;
            align-items: center;
            gap: 2rem;
        }
        #vault-screen-content, #win-screen-content {
            background-color: rgba(255, 255, 255, 0.8);
            padding: 2rem;
            border-radius: 15px;
            border: 4px solid var(--c-black);
            box-shadow: 0 6px 0 var(--c-black);
            text-align: center;
        }
        .keypad-input-display {
            font-family: var(--font-display);
            font-size: 1.5rem;
            letter-spacing: 0.5rem;
            padding: 1rem;
            border: 4px solid var(--c-black);
            background-color: var(--c-white);
            margin: 1.5rem 0;
            min-height: 60px;
            border-radius: 8px;
            width: 100%;
            max-width: 400px;
        }
        #keypad-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-width: 250px;
            margin: 0 auto;
        }
        .keypad-btn {
            font-family: var(--font-display);
            padding: 15px;
            font-size: 1.2rem;
        }

        #prize-display {
            display: none;
            text-align: center;
            animation: popIn 0.5s ease-out;
        }
        #prize-display h2 {
            font-family: var(--font-display);
            font-size: 2rem;
            color: var(--c-yellow);
            text-shadow: 3px 3px 0 var(--c-black);
            margin-bottom: 1rem;
        }
        #prize-text {
            font-size: 1.5rem;
            padding: 1.5rem;
            background: var(--c-white);
            border: 4px solid var(--c-black);
            border-radius: 10px;
            box-shadow: 0 4px 0 var(--c-black);
        }

        @media (max-width: 768px) {
            .game-container { padding: 1rem; height: 100vh; max-height: none; }
            .header { flex-direction: column; gap: 0.5rem; }
            #world-map-path { flex-direction: column; height: 95%; justify-content: space-around; width: auto; }
            .path-line { width: 8px; height: 100%; left: 50%; transform: translateX(-50%); }
            #player-map-avatar { transition: top 0.5s ease-in-out, left 0.1s; }
        }

    </style>
</head>
<body>

    <div class="game-container">

        <!-- ===== START SCREEN ===== -->
        <div id="start-screen" class="screen active">
            <div id="start-screen-content">
                <h1 class="title">Math Kingdom Adventure</h1>
                <img id="avatar-preview" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0NSIgZmlsbD0iI2NjYyIvPjxwYXRoIGQ9Ik01MCAxMGMtMTYuNTcgMC0zMCAxMy40My0zMCAzMHMxMy40MyAzMCAzMCAzMCAzMC0xMy40MyAzMC0zMFM2Ni41NyAxMCA1MCAxMHptMCA1YTEwIDEwIDAgMSAxIDAgMjAgMTAgMTAgMCAwIDEgMC0yMHptMCA1MGMtMTEuMDUgMC0yMC41My02LjU5LTI0LjQ5LTE2LjA4QzMxLjI4IDQyLjU4IDQwLjM3IDQwIDUwIDQwczE4LjcyIDIuNTggMjQuNDkgNi45MkM3MC41MyA1Ni40MSA2MS4wNSA2NSA1MCA2NXoiIGZpbGw9IiNmZmYiLz48L3N2Zz4=" alt="Avatar Preview">
                <input type="file" id="avatar-upload" accept="image/*" style="display: none;">
                <label for="avatar-upload" id="avatar-label">Upload Avatar</label>
                <input type="text" id="player-name-input" placeholder="Enter Explorer Name">
                <button id="start-game-btn" class="pixel-button">Start Adventure</button>
            </div>
        </div>

        <!-- ===== GAME SCREEN ===== -->
        <div id="game-screen" class="screen">
            <header class="header">
                <div class="player-info">
                    <img id="player-avatar-display" alt="Player Avatar">
                    <h2 id="player-name-display"></h2>
                </div>
                <div class="stats-display">
                    <div class="stat" id="code-pieces-stat"></div>
                    <div class="stat" id="mushrooms-stat"></div>
                    <div class="stat">
                        <button id="hint-btn" aria-label="Use Hint Star"></button>
                    </div>
                </div>
            </header>
            <main id="world-map-container">
                <div id="player-map-avatar"></div>
                <div class="path-line"></div>
                <div id="world-map-path">
                    <!-- Stages will be generated here -->
                </div>
            </main>
        </div>

        <!-- ===== VAULT SCREEN ===== -->
        <div id="vault-screen" class="screen">
            <div id="vault-screen-content">
                <h1 class="title">The Final Vault!</h1>
                <p>Enter the 10-digit secret code to claim your prize!</p>
                <div id="keypad-input-display" class="keypad-input-display"></div>
                <div id="keypad-grid"></div>
                <div style="display: flex; justify-content: center; gap: 10px; margin-top: 1rem;">
                    <button id="unlock-btn" class="pixel-button yellow">Unlock</button>
                </div>
            </div>
        </div>
        
        <!-- ===== WIN SCREEN ===== -->
        <div id="win-screen" class="screen">
            <div id="win-screen-content">
                 <div id="prize-display">
                    <h2 class="title">You Won!</h2>
                    <p id="prize-text"></p>
                    <button id="play-again-btn" class="pixel-button yellow" style="margin-top: 2rem;">Play Again</button>
                </div>
            </div>
        </div>

    </div>

    <!-- ===== QUESTION MODAL ===== -->
    <div id="question-modal-overlay">
        <div id="question-modal">
            <h2 id="question-title">Puzzle</h2>
            <p id="question-prompt"></p>
            <div id="answer-container">
                 <input type="number" id="answer-input" placeholder="Type answer here">
                 <button id="check-answer-btn" class="pixel-button">Check Answer</button>
            </div>
            <div id="question-feedback"></div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- DATA & STATE MANAGEMENT --- //
        const SECRET_CODE = "8293174650"; // The 10-digit code to unlock the vault.
        const GAME_DATA = {
            player: { explorerName: "", avatar: "", superMushrooms: 3, superStars: 1, solvedPuzzles: [], currentPuzzleIndex: 0, codeJournal: Array(10).fill(null) },
            gameConfig: { totalPuzzles: 10, maxMushrooms: 3 },
            puzzles: [
                { id: "puzzle_0", type: "text-box", prompt: "Mario and Luigi collected coins. Mario found 1,250 coins and Luigi found 2,130 coins. How many coins did they collect in total?", correct: "3380", hint: "in total" },
                { id: "puzzle_1", type: "text-box", prompt: "Princess Peach baked 5,000 cupcakes for the kingdom festival. By noon, 2,350 cupcakes had been eaten. How many cupcakes were left?", correct: "2650", hint: "were left" },
                { id: "puzzle_2", type: "text-box", prompt: "Bowser built a castle with 8,400 bricks. His minions accidentally knocked down 1,520 bricks. How many bricks are still standing?", correct: "6880", hint: "still standing" },
                { id: "puzzle_3", type: "text-box", prompt: "In a great race, Yoshi ran 4,567 meters and Toad ran 3,123 meters. How many more meters did Yoshi run than Toad?", correct: "1444", hint: "How many more" },
                { id: "puzzle_4", type: "text-box", prompt: "The Royal Bank of Mushroom Kingdom had 9,999 gold coins. A generous donor added 1 more coin to the vault. What is the new total?", correct: "10000", hint: "added 1 more" },
                { id: "puzzle_5", type: "text-box", prompt: "Goomba Village has 3,456 Goombas. Koopa Troopa Town has 2,890 Koopas. How many characters are there altogether?", correct: "6346", hint: "altogether" },
                { id: "puzzle_6", type: "text-box", prompt: "A warp pipe is 7,200 inches long. A Piranha Plant grows and breaks off 850 inches. How long is the pipe now?", correct: "6350", hint: "breaks off" },
                { id: "puzzle_7", type: "text-box", prompt: "For the annual Star Festival, the Toads collected 6,145 fallen stars. Last year, they only collected 4,500. What is the difference between the two years?", correct: "1645", hint: "What is the difference" },
                { id: "puzzle_8", type: "text-box", prompt: "Lakitu flew 5,678 feet on his cloud on Monday. On Tuesday, he flew another 3,210 feet. How many feet did he fly in all?", correct: "8888", hint: "in all" },
                { id: "puzzle_9", type: "text-box", prompt: "The grand prize chest costs 9,500 coins. You have saved 7,850 coins. How many more coins do you need to earn?", correct: "1650", hint: "How many more... do you need" }
            ],
            prizes: ["Free 5 mins recess", "Snacks", "Chocolate", "Drinks", "5 mins free time"],
            sfx: { click: "data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAAD//w==", correct: "data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAAD//w==", incorrect: "data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAAD//w==", win: "data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAAD//w==" }
        };

        let gameState = {};

        // --- DOM Elements --- //
        const screens = { start: document.getElementById('start-screen'), game: document.getElementById('game-screen'), vault: document.getElementById('vault-screen'), win: document.getElementById('win-screen') };
        const playerNameInput = document.getElementById('player-name-input');
        const avatarUpload = document.getElementById('avatar-upload');
        const avatarPreview = document.getElementById('avatar-preview');
        const startGameBtn = document.getElementById('start-game-btn');
        const playerNameDisplay = document.getElementById('player-name-display');
        const playerAvatarDisplay = document.getElementById('player-avatar-display');
        const playerMapAvatar = document.getElementById('player-map-avatar');
        const codePiecesStat = document.getElementById('code-pieces-stat');
        const mushroomsStat = document.getElementById('mushrooms-stat');
        const hintBtn = document.getElementById('hint-btn');
        const worldMapPath = document.getElementById('world-map-path');
        const questionModalOverlay = document.getElementById('question-modal-overlay');
        const questionModal = document.getElementById('question-modal');
        const questionTitle = document.getElementById('question-title');
        const questionPrompt = document.getElementById('question-prompt');
        const answerContainer = document.getElementById('answer-container');
        const answerInput = document.getElementById('answer-input');
        const checkAnswerBtn = document.getElementById('check-answer-btn');
        const questionFeedback = document.getElementById('question-feedback');
        // Vault and Win Screen Elements
        const keypadDisplay = document.getElementById('keypad-input-display');
        const keypadGrid = document.getElementById('keypad-grid');
        const unlockBtn = document.getElementById('unlock-btn');
        const prizeDisplay = document.getElementById('prize-display');
        const prizeText = document.getElementById('prize-text');
        const playAgainBtn = document.getElementById('play-again-btn');

        // --- SVG FACTORY --- //
        const SVG = {
            codeCoin: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${'var(--c-yellow)'}" stroke="${'var(--c-black)'}" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 11.21 12.77 10.5 12 10.5c-.77 0-1.536.71-2.121 1.288L9 14.182zM12 6a7.5 7.5 0 100 15 7.5 7.5 0 000-15z" /></svg>`,
            mushroom: (color = 'var(--c-red)') => `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${color}" stroke="${'var(--c-black)'}" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M21.75 17.25v-.228a4.5 4.5 0 00-.12-1.03l-2.268-9.64a3.375 3.375 0 00-3.285-2.653H7.923a3.375 3.375 0 00-3.285 2.653l-2.268 9.64a4.5 4.5 0 00-.12 1.03v.228m19.5 0a3 3 0 01-3 3H5.25a3 3 0 01-3-3m19.5 0a3 3 0 00-3-3H5.25a3 3 0 00-3 3m16.5 0h.008v.008h-.008v-.008zm-3 0h.008v.008h-.008v-.008zm-3 0h.008v.008h-.008v-.008zm-3 0h.008v.008h-.008v-.008z" /></svg>`,
            star: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="yellow" stroke="${'var(--c-black)'}" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z" /></svg>`
        };

        // --- AUDIO --- //
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const sfx = {};
        
        async function setupAudio() {
            for (const key in GAME_DATA.sfx) {
                try {
                    const response = await fetch(GAME_DATA.sfx[key]);
                    const arrayBuffer = await response.arrayBuffer();
                    const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
                    sfx[key] = audioBuffer;
                } catch (e) { console.error(`Failed to decode audio for ${key}:`, e); }
            }
        }
        function playSound(name) {
            if (sfx[name] && audioCtx.state === 'running') {
                const source = audioCtx.createBufferSource();
                source.buffer = sfx[name];
                source.connect(audioCtx.destination);
                source.start(0);
            }
        }

        // --- STATE & UI MANAGEMENT --- //
        const GameStateManager = {
            init() {
                gameState = JSON.parse(JSON.stringify(GAME_DATA));
                if (this.load()) {
                    UIManager.showScreen('game');
                    UIManager.renderGameUI();
                } else {
                    UIManager.showScreen('start');
                }
            },
            save() {
                localStorage.setItem('mathKingdomAdventureState', JSON.stringify(gameState.player));
            },
            load() {
                const savedState = localStorage.getItem('mathKingdomAdventureState');
                if (savedState) {
                    let loadedPlayerState = JSON.parse(savedState);
                    // Ensure the structure is correct, especially for new properties like codeJournal
                    gameState.player = { ...GAME_DATA.player, ...loadedPlayerState };
                    return true;
                }
                return false;
            },
            reset() {
                localStorage.removeItem('mathKingdomAdventureState');
                location.reload();
            },
            getCurrentPuzzle() {
                return gameState.puzzles[gameState.player.currentPuzzleIndex];
            },
            getPuzzleById(id) {
                return gameState.puzzles.find(p => p.id === id);
            },
        };

        const UIManager = {
            showScreen(screenName) {
                Object.values(screens).forEach(s => s.classList.remove('active'));
                screens[screenName].classList.add('active');
            },
            renderPlayerStats() {
                playerNameDisplay.textContent = gameState.player.explorerName;
                playerAvatarDisplay.src = gameState.player.avatar || avatarPreview.src;
                
                const codePiecesFound = gameState.player.codeJournal.filter(c => c !== null).length;
                codePiecesStat.innerHTML = `${SVG.codeCoin} <span class="stat-count">${codePiecesFound}/${gameState.gameConfig.totalPuzzles}</span>`;
                mushroomsStat.innerHTML = `${SVG.mushroom()} <span class="stat-count">${gameState.player.superMushrooms}</span>`;
                hintBtn.innerHTML = `${SVG.star}`;
                hintBtn.disabled = gameState.player.superStars <= 0;
            },
            renderWorldMap() {
                worldMapPath.innerHTML = '';
                gameState.puzzles.forEach((puzzle, index) => {
                    const stageEl = document.createElement('div');
                    stageEl.classList.add('stage');
                    stageEl.dataset.index = index;
                    stageEl.id = `stage-${index}`;
                    stageEl.textContent = index + 1;
                    
                    if (gameState.player.solvedPuzzles.includes(puzzle.id)) {
                        stageEl.classList.add('completed');
                    } else if (index === gameState.player.currentPuzzleIndex) {
                        stageEl.classList.add('unlocked');
                    }
                    worldMapPath.appendChild(stageEl);
                });
                this.updatePlayerMapAvatar();
            },
            updatePlayerMapAvatar() {
                playerMapAvatar.src = gameState.player.avatar || avatarPreview.src;
                const currentStageIndex = gameState.player.currentPuzzleIndex;
                const targetStage = document.getElementById(`stage-${currentStageIndex}`);
                if (targetStage) {
                    const targetRect = targetStage.getBoundingClientRect();
                    const mapRect = worldMapPath.getBoundingClientRect();
                    
                    let targetTop = targetRect.top - mapRect.top + (targetRect.height / 2) - (playerMapAvatar.height / 2);
                    let targetLeft = targetRect.left - mapRect.left + (targetRect.width / 2) - (playerMapAvatar.width / 2);

                    playerMapAvatar.style.top = `${targetTop}px`;
                    playerMapAvatar.style.left = `${targetLeft}px`;
                }
            },
            showQuestionModal(puzzle) {
                questionTitle.textContent = `Puzzle #${gameState.player.currentPuzzleIndex + 1}`;
                questionPrompt.innerHTML = puzzle.prompt;
                answerInput.value = '';
                checkAnswerBtn.dataset.puzzleId = puzzle.id;
                questionFeedback.textContent = '';
                questionFeedback.className = '';
                
                // Reset to answer mode
                answerContainer.innerHTML = `
                    <input type="number" id="answer-input" placeholder="Type answer here">
                    <button id="check-answer-btn" class="pixel-button" data-puzzle-id="${puzzle.id}">Check Answer</button>
                `;
                answerContainer.querySelector('#check-answer-btn').addEventListener('click', handleAnswerCheck);

                questionModalOverlay.style.display = 'flex';
                answerContainer.querySelector('#answer-input').focus();
            },
            hideQuestionModal() {
                questionModalOverlay.style.display = 'none';
            },
            showVaultScreen() {
                this.showScreen('vault');
                this.renderFinalKeypad();
            },
            renderFinalKeypad() {
                let keypadHTML = '';
                const numbers = [1, 2, 3, 4, 5, 6, 7, 8, 9, 'DEL', 0, ''];
                numbers.forEach(num => {
                    keypadHTML += `<button class="pixel-button keypad-btn" ${num === '' ? 'style="visibility:hidden;"' : ''}>${num}</button>`;
                });
                keypadGrid.innerHTML = keypadHTML;

                keypadGrid.querySelectorAll('.keypad-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        playSound('click');
                        const value = btn.textContent;
                        let currentCode = keypadDisplay.textContent;
                        if (value === 'DEL') {
                            keypadDisplay.textContent = currentCode.slice(0, -1);
                        } else if (currentCode.length < 10) {
                            keypadDisplay.textContent += value;
                        }
                    });
                });
                keypadDisplay.textContent = '';
            },
            renderGameUI() {
                this.renderPlayerStats();
                this.renderWorldMap();
            }
        };

        // --- GAME LOGIC --- //
        function handleStartGame() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const name = playerNameInput.value.trim();
            if (!name) { alert("Please enter your Explorer Name!"); return; }
            playSound('click');
            gameState.player.explorerName = name;
            gameState.player.avatar = avatarPreview.src;
            GameStateManager.save();
            UIManager.showScreen('game');
            UIManager.renderGameUI();
        }

        function handleStageClick(e) {
            const stage = e.target.closest('.stage.unlocked');
            if (stage) {
                playSound('click');
                const puzzleIndex = parseInt(stage.dataset.index);
                if (puzzleIndex === gameState.player.currentPuzzleIndex) {
                    const puzzle = gameState.puzzles[puzzleIndex];
                    UIManager.showQuestionModal(puzzle);
                }
            }
        }
        
        function handleAnswerCheck(e) {
            const btn = e.target;
            const puzzleId = btn.dataset.puzzleId;
            const puzzle = GameStateManager.getPuzzleById(puzzleId);
            const userAnswer = btn.parentElement.querySelector('#answer-input').value.trim();
            
            if (userAnswer === puzzle.correct) {
                handleCorrectAnswer(puzzle);
            } else {
                handleIncorrectAnswer();
            }
        }
        
        function handleCorrectAnswer(puzzle) {
            playSound('correct');
            const puzzleIndex = gameState.player.currentPuzzleIndex;
            const secretDigit = SECRET_CODE[puzzleIndex];

            // Update state
            if (!gameState.player.solvedPuzzles.includes(puzzle.id)) {
                gameState.player.solvedPuzzles.push(puzzle.id);
            }
            gameState.player.codeJournal[puzzleIndex] = secretDigit;
            
            // Update modal UI for copying the code
            answerContainer.innerHTML = `<button id="continue-btn" class="pixel-button yellow">Continue</button>`;
            answerContainer.querySelector('#continue-btn').addEventListener('click', () => {
                playSound('click');
                gameState.player.currentPuzzleIndex++;
                GameStateManager.save();
                UIManager.hideQuestionModal();
                UIManager.renderGameUI();
                if (gameState.player.solvedPuzzles.length === gameState.gameConfig.totalPuzzles) {
                    UIManager.showVaultScreen();
                }
            });

            questionFeedback.className = 'correct';
            questionFeedback.innerHTML = `Correct! Write this down: <span class="feedback-code">${secretDigit}</span>`;
        }

        function handleIncorrectAnswer() {
            playSound('incorrect');
            gameState.player.superMushrooms--;
            UIManager.renderPlayerStats();
            GameStateManager.save();

            questionFeedback.className = 'incorrect';
            questionModal.classList.add('shake');
            setTimeout(() => questionModal.classList.remove('shake'), 500);

            if (gameState.player.superMushrooms > 0) {
                questionFeedback.textContent = 'Womp womp! Try re-reading the problem.';
            } else {
                questionFeedback.textContent = 'Out of mushrooms! Restarting this puzzle...';
                answerContainer.querySelector('#check-answer-btn').disabled = true;
                setTimeout(() => {
                    gameState.player.superMushrooms = gameState.gameConfig.maxMushrooms;
                    UIManager.hideQuestionModal();
                    UIManager.renderPlayerStats();
                    GameStateManager.save();
                }, 2000);
            }
        }
        
        function handleHint() {
            if (gameState.player.superStars > 0) {
                playSound('click');
                const puzzle = GameStateManager.getCurrentPuzzle();
                if (puzzle && puzzle.hint) {
                    questionPrompt.innerHTML = puzzle.prompt.replace(puzzle.hint, `<span class="highlight">${puzzle.hint}</span>`);
                    gameState.player.superStars--;
                    UIManager.renderPlayerStats();
                    GameStateManager.save();
                }
            }
        }

        function handleUnlockVault() {
            playSound('click');
            const enteredCode = keypadDisplay.textContent;
            if (enteredCode === SECRET_CODE) {
                playSound('win');
                UIManager.showScreen('win');
                const randomIndex = Math.floor(Math.random() * gameState.prizes.length);
                prizeText.textContent = gameState.prizes[randomIndex];
                prizeDisplay.style.display = 'block';
                GameStateManager.reset(); // Reset for next player
            } else {
                playSound('incorrect');
                const vaultContent = document.getElementById('vault-screen-content');
                keypadDisplay.textContent = 'WRONG CODE';
                vaultContent.classList.add('shake');
                setTimeout(() => {
                    vaultContent.classList.remove('shake');
                    keypadDisplay.textContent = '';
                }, 1000);
            }
        }

        // --- Event Listeners Setup --- //
        function initEventListeners() {
            startGameBtn.addEventListener('click', handleStartGame);
            playAgainBtn.addEventListener('click', GameStateManager.reset);
            worldMapPath.addEventListener('click', handleStageClick);
            hintBtn.addEventListener('click', handleHint);
            unlockBtn.addEventListener('click', handleUnlockVault);

            avatarUpload.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = e => avatarPreview.src = e.target.result;
                    reader.readAsDataURL(file);
                }
            });
        }

        // --- Game Initialization --- //
        GameStateManager.init();
        setupAudio();
        initEventListeners();
    });
    </script>
</body>
</html>

