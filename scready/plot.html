<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Detective Agency</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Special+Agent&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }

        h1, h2, h3 {
            font-family: 'Special Agent', monospace;
        }

        .detective-theme {
            background-color: #2c3e50; /* Midnight Blue */
            color: #ecf0f1; /* Clouds White */
        }
        
        .btn-primary {
            background-color: #f1c40f; /* Sunflower Yellow */
            color: #2c3e50;
            transition: all 0.2s ease-in-out;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .btn-secondary {
            background-color: #34495e; /* Wet Asphalt */
            color: #ecf0f1;
            transition: all 0.2s ease-in-out;
        }
        .btn-secondary:hover {
             background-color: #4e6a85;
        }

        .slide-content {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .progress-bar-fill {
            transition: width 0.5s ease-in-out;
        }
        
        .source-text-container::-webkit-scrollbar { width: 8px; }
        .source-text-container::-webkit-scrollbar-track { background: #34495e; }
        .source-text-container::-webkit-scrollbar-thumb { background-color: #f1c40f; border-radius: 20px; }

        /* Coordinate Grid Styles */
        .coordinate-grid { position: relative; width: 400px; height: 400px; background-size: 40px 40px; background-image: linear-gradient(to right, #e5e7eb 1px, transparent 1px), linear-gradient(to bottom, #e5e7eb 1px, transparent 1px); border-left: 2px solid #374151; border-bottom: 2px solid #374151; }
        .grid-point { position: absolute; width: 16px; height: 16px; background-color: #f1c40f; border-radius: 50%; border: 2px solid #2c3e50; transform: translate(-50%, 50%); cursor: pointer; transition: all 0.2s; }
        .grid-point:hover, .grid-point.selected { background-color: #dc2626; transform: translate(-50%, 50%) scale(1.2); }
        .axis-label { position: absolute; font-weight: 600; color: #4b5563; }
        .x-axis-label { bottom: -25px; left: 50%; transform: translateX(-50%); }
        .y-axis-label { left: -60px; top: 50%; transform: translateY(-50%) rotate(-90deg); }
        .grid-number { position: absolute; font-size: 0.75rem; color: #4b5563; }

        /* Styles for the grid in the dark source panel */
        .source-grid {
            background-image: linear-gradient(to right, #4b5563 1px, transparent 1px), linear-gradient(to bottom, #4b5563 1px, transparent 1px);
            border-left-color: #9ca3af;
            border-bottom-color: #9ca3af;
        }
        .source-grid .axis-label, .source-grid .grid-number {
            color: #d1d5db;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div id="app-container">
        <!-- APP HEADER -->
        <header id="app-header" class="detective-theme p-4 shadow-lg flex justify-between items-center hidden">
            <button id="home-btn" class="btn-secondary font-bold py-2 px-4 rounded-lg text-sm">Home</button>
            <div class="w-1/2">
                <div class="w-full bg-gray-600 rounded-full h-4">
                    <div id="progress-bar" class="bg-yellow-400 h-4 text-xs font-medium text-blue-900 text-center p-0.5 leading-none rounded-full progress-bar-fill" style="width: 0%"></div>
                </div>
                <div id="progress-label" class="text-center text-sm mt-1 text-white"></div>
            </div>
            <div class="w-24"></div> <!-- Spacer -->
        </header>

        <!-- HOME VIEW -->
        <main id="home-view" class="h-screen flex flex-col justify-center items-center text-center p-6 bg-gray-800 text-white">
            <div class="max-w-2xl">
                <h1 class="text-6xl font-bold text-yellow-400 mb-2">Math Detective Agency</h1>
                <p class="text-xl text-gray-300 mb-8">Your next case is ready. Use your math skills to uncover the facts.</p>
                <div class="space-x-4">
                    <button id="start-test-btn" class="btn-primary text-xl font-bold py-4 px-8 rounded-lg">Start Investigation</button>
                    <button id="start-practice-btn" class="btn-secondary text-xl font-bold py-4 px-8 rounded-lg">Hone Your Skills</button>
                </div>
            </div>
        </main>

        <!-- ASSESSMENT VIEW -->
        <main id="assessment-view" class="p-4 md:p-8 hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 max-w-7xl mx-auto">
                <div class="bg-gray-700 text-white p-6 rounded-xl shadow-lg h-[80vh] flex flex-col">
                    <h2 class="text-2xl font-bold mb-4 text-yellow-400 border-b-2 border-yellow-400 pb-2">Case File: The Speedy Sprout</h2>
                    <div id="source-text-container" class="source-text-container overflow-y-auto pr-2 flex-grow"></div>
                </div>
                <div id="question-container" class="bg-white p-6 rounded-xl shadow-lg h-[80vh] flex flex-col slide-content"></div>
            </div>
        </main>

        <!-- PRACTICE VIEW -->
        <main id="practice-view" class="p-4 md:p-8 hidden">
             <div id="practice-container" class="bg-white p-8 rounded-xl shadow-lg max-w-3xl mx-auto mt-10 flex flex-col items-center slide-content"></div>
        </main>

        <!-- CONFIRMATION VIEW -->
        <main id="confirmation-view" class="h-screen flex flex-col justify-center items-center text-center p-6 bg-gray-800 text-white hidden">
             <div class="max-w-2xl">
                <svg class="mx-auto h-24 w-24 text-yellow-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" />
                </svg>
                <h1 class="text-4xl font-bold text-yellow-400 mt-4 mb-2">Ready to submit your findings?</h1>
                <p class="text-lg text-gray-300 mb-8">You can review your answers one last time or submit now to see your score. This action is final.</p>
                <div class="flex space-x-4 justify-center">
                    <button id="final-review-btn" class="btn-secondary font-bold py-3 px-6 rounded-lg">Review Answers</button>
                    <button id="final-submit-btn" class="btn-primary font-bold py-3 px-6 rounded-lg">Submit for Grading</button>
                </div>
            </div>
        </main>

        <!-- SCORE VIEW -->
        <main id="score-view" class="h-screen flex flex-col justify-center items-center text-center p-6 bg-gray-800 text-white hidden">
             <div class="max-w-2xl">
                <h1 class="text-3xl font-bold text-yellow-400 mb-2">Case Closed!</h1>
                <div id="score-display" class="my-8">
                    <!-- Score will be rendered here by JS -->
                </div>
                <p class="text-lg text-gray-300 mb-8">Your case file has been submitted and archived.</p>
                <div class="flex space-x-4 justify-center">
                    <button id="download-work-btn" class="btn-secondary font-bold py-3 px-6 rounded-lg">Download Work File</button>
                    <button id="download-pdf-btn" class="btn-secondary font-bold py-3 px-6 rounded-lg">Download Report as PDF</button>
                </div>
            </div>
            <div class="absolute bottom-4 right-4"><a href="#" id="admin-reset-link" class="text-sm text-gray-500 hover:text-yellow-400">Admin Reset</a></div>
        </main>
    </div>
    
    <div id="password-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl text-gray-800">
            <h3 class="text-xl font-bold mb-4">Enter Admin Password</h3>
            <input type="password" id="password-input" class="border p-2 rounded w-full mb-4">
            <div class="flex justify-end space-x-2">
                <button id="password-cancel" class="btn-secondary py-2 px-4 rounded-lg">Cancel</button>
                <button id="password-submit" class="btn-primary py-2 px-4 rounded-lg">Submit</button>
            </div>
            <p id="password-error" class="text-red-500 text-sm mt-2 hidden">Incorrect Password.</p>
        </div>
    </div>

<script id="progress-data" type="application/json"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- DATA ---
    const sourceText = {
        title: "Detective's Log",
        body: "We have a new case involving a mysterious plant, codenamed the 'Speedy Sprout.' It appeared overnight in the city conservatory. We are tracking its growth daily. The lead botanist, Dr. Aris, believes its growth rate is unlike any known species. We are plotting its height in centimeters (cm) at the same time each day.",
        dataPoints: [
            {day: 0, height: 0, label: "(0, 0)"},
            {day: 2, height: 4, label: "(2, 4)"},
            {day: 4, height: 8, label: "(4, 8)"},
            {day: 5, height: 10, label: "(5, 10)"},
            {day: 6, height: 12, label: "(6, 12)"},
            {day: 8, height: 16, label: "(8, 16)"},
        ],
        conclusion: "Below is the official evidence graph plotting these points. The x-axis represents the Day number, and the y-axis represents the Height in centimeters."
    };

    const assessmentQuestions = [
        // Identify/Recall
        {
            type: 'mc',
            question: "According to the case file, what does the x-axis on the evidence graph represent?",
            options: ["Height in cm", "Day Number", "Plant Species", "Growth Rate"],
            answer: "Day Number"
        },
        {
            type: 'mc',
            question: "What was the recorded height of the Speedy Sprout on Day 8?",
            options: ["8 cm", "12 cm", "16 cm", "10 cm"],
            answer: "16 cm"
        },
        {
            type: 'ms',
            question: "Which of the following ordered pairs represent points plotted on the evidence graph? (Select all that apply)",
            options: ["(2, 4)", "(3, 6)", "(6, 12)", "(8, 14)"],
            answer: ["(2, 4)", "(6, 12)"]
        },
        // Infer/Conclude
        {
            type: 'mc',
            question: "What does the ordered pair (4, 8) signify in the context of this investigation?",
            options: [
                "On day 8, the plant was 4 cm tall.",
                "The plant grew by 4 cm in 8 days.",
                "On day 4, the plant was 8 cm tall.",
                "The plant grew by 8 cm in 4 days."
            ],
            answer: "On day 4, the plant was 8 cm tall."
        },
        {
            type: 'ebsr',
            partA: {
                question: "Between which two recorded measurements did the plant grow at the fastest rate (cm per day)?",
                options: ["Day 0 to Day 2", "Day 4 to Day 5", "Day 6 to Day 8", "The rate was constant"],
                answer: "The rate was constant"
            },
            partB: {
                question: "Which evidence from the log supports this conclusion?",
                options: [
                    "The points (0,0) and (2,4) show a growth of 4 cm in 2 days.",
                    "The plant grew 2 cm every day.",
                    "The points on the graph form a straight line.",
                    "All of the above."
                ],
                answer: "All of the above."
            }
        },
        {
            type: 'mc',
            question: "Based on the pattern shown on the graph, what would be the most likely height of the plant on Day 7?",
            options: ["12 cm", "13 cm", "14 cm", "15 cm"],
            answer: "14 cm"
        },
        {
            type: 'te_hotspot',
            question: "The detective observes the plant again and notes its height is exactly 10 cm. Click on the point on the graph that represents this observation.",
            answer: "(5, 10)"
        },
        // Analyze/Evaluate
        {
            type: 'mc',
            question: "Which statement best describes the overall growth pattern of the Speedy Sprout?",
            options: [
                "The plant's growth is random and unpredictable.",
                "The plant grows faster as it gets older.",
                "The plant grows at a steady, constant rate.",
                "The plant's growth is slowing down."
            ],
            answer: "The plant grows at a steady, constant rate."
        },
        {
            type: 'ms',
            question: "Which of the following statements can be concluded from the evidence graph? (Select all that apply)",
            options: [
                "The plant doubles in height every two days.",
                "The plant started growing before it was discovered on Day 0.",
                "For every day that passes, the plant grows by 2 cm.",
                "The plant will be 20 cm tall on Day 10 if the pattern continues."
            ],
            answer: ["For every day that passes, the plant grows by 2 cm.", "The plant will be 20 cm tall on Day 10 if the pattern continues."]
        },
        {
            type: 'mc',
            question: "Dr. Aris claims the data from Day 0 to Day 2 is the most significant clue. Why might this be strong evidence that the plant is unusual?",
            options: [
                "Because it was the first measurement taken.",
                "Because growing 4 cm from a seed in just two days is extremely fast.",
                "Because the point (2, 4) is the easiest to see on the graph.",
                "Because it's the only point with an even number for the day."
            ],
            answer: "Because growing 4 cm from a seed in just two days is extremely fast."
        },
    ];
    
    // Simplified practice for brevity
    const practiceActivities = [
        {type: 'identify', question: "What is the ordered pair for the point shown?", point: [3,5], answer: "(3, 5)"},
        {type: 'plot', question: "Click on the location for the ordered pair (7, 2).", point: [7,2], answer: "(7, 2)"},
        {type: 'interpret', question: "If x-axis is 'Hours' and y-axis is 'Miles', what does (2, 100) mean?", answer: "Travelled 100 miles in 2 hours."}
    ];

    // --- STATE ---
    let appState = { currentView: 'home', currentQuestionIndex: 0, currentPracticeIndex: 0, studentAnswers: {}, mode: 'test' };

    // --- DOM ELEMENTS ---
    const views = { home: document.getElementById('home-view'), assessment: document.getElementById('assessment-view'), practice: document.getElementById('practice-view'), confirmation: document.getElementById('confirmation-view'), score: document.getElementById('score-view') };
    const appHeader = document.getElementById('app-header');
    const questionContainer = document.getElementById('question-container');
    const sourceTextContainer = document.getElementById('source-text-container');
    const progressBar = document.getElementById('progress-bar');
    const progressLabel = document.getElementById('progress-label');
    const passwordModal = document.getElementById('password-modal');

    // --- LOGIC ---
    
    const renderCoordinateGrid = (points, interactive = false, savedAnswer = null, extraClass = '') => {
        let gridHtml = `<div class="mx-auto coordinate-grid ${extraClass}" id="grid">
            <div class="axis-label x-axis-label">Day Number</div>
            <div class="axis-label y-axis-label">Height (cm)</div>
        `;
        // Draw grid numbers
        for (let i = 2; i <= 10; i += 2) {
            gridHtml += `<div class="grid-number" style="bottom: -20px; left: ${i * 40}px; transform: translateX(-50%);">${i}</div>`; // X-axis
        }
        for (let i = 2; i <= 20; i += 2) {
             gridHtml += `<div class="grid-number" style="bottom: ${i * 20}px; left: -10px; transform: translateY(50%);">${i}</div>`; // Y-axis
        }
        // Draw points
        points.forEach(p => {
            const isSelected = savedAnswer === p.label;
            gridHtml += `<div class="grid-point ${interactive ? 'hotspot' : ''} ${isSelected ? 'selected' : ''}" style="bottom: ${p.height * 20}px; left: ${p.day * 40}px;" data-coord="${p.label}" title="${p.label}"></div>`;
        });
        gridHtml += `</div>`;
        return gridHtml;
    };

    const downloadWorkFile = () => {
        // Ensure the last answer is saved before downloading, especially if called from score screen
        if(appState.currentView === 'assessment') saveAnswer();

        const dataString = JSON.stringify(appState.studentAnswers);
        
        // Create a new script tag content
        const scriptTagString = `<script id="progress-data" type="application/json">${dataString}<\/script>`;
        
        // Get the current HTML and replace the old script tag with the new one
        let currentHtml = document.documentElement.outerHTML;
        currentHtml = currentHtml.replace(/<script id="progress-data" type="application\/json">.*?<\/script>/, scriptTagString);

        const blob = new Blob([currentHtml], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = 'math_detective_progress.html';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    };

    const downloadPdfReport = async () => {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
            orientation: 'p',
            unit: 'px',
            format: 'a4'
        });
        
        const loadingOverlay = document.createElement('div');
        loadingOverlay.innerHTML = `<div class="fixed inset-0 bg-black bg-opacity-75 flex flex-col items-center justify-center z-50 text-white"><svg class="animate-spin h-10 w-10 mb-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 2a10 10 0 0 0-9.9 10" stroke-width="4" stroke-linecap="round"/></svg><p>Generating PDF Report...</p></div>`;
        document.body.appendChild(loadingOverlay);

        const pdfWidth = pdf.internal.pageSize.getWidth();

        for (let i = 0; i < assessmentQuestions.length; i++) {
            const qData = assessmentQuestions[i];
            const studentAnswer = appState.studentAnswers[i];

            const reportContainer = document.createElement('div');
            reportContainer.style.width = '800px';
            reportContainer.style.padding = '20px';
            reportContainer.style.backgroundColor = 'white';
            reportContainer.style.color = 'black';
            reportContainer.style.fontFamily = 'Inter, sans-serif';

            let answerContent = '';
            
            const createOptionHtml = (text, isChecked, isCorrectSource) => {
                let bgColor = '#ffffff'; // white
                let indicator = '';
                if (isChecked) {
                    bgColor = isCorrectSource ? '#dcfce7' : '#fee2e2'; // green-100 or red-100
                    indicator = isCorrectSource ? ' <strong style="color: #166534;">(Selected - Correct)</strong>' : ' <strong style="color: #991b1b;">(Selected - Incorrect)</strong>';
                } else if (isCorrectSource) {
                    indicator = ' <strong style="color: #166534;">(Correct Answer)</strong>';
                }
                return `<div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin-bottom: 8px; background-color: ${bgColor};">${text}${indicator}</div>`;
            };

            switch (qData.type) {
                case 'mc':
                    answerContent = qData.options.map(opt => createOptionHtml(opt, studentAnswer === opt, qData.answer === opt)).join('');
                    break;
                case 'ms':
                    answerContent = qData.options.map(opt => createOptionHtml(opt, studentAnswer?.includes(opt), qData.answer.includes(opt))).join('');
                    break;
                case 'ebsr':
                    const partA_html = qData.partA.options.map(opt => createOptionHtml(opt, studentAnswer?.partA === opt, qData.partA.answer === opt)).join('');
                    const partB_html = qData.partB.options.map(opt => createOptionHtml(opt, studentAnswer?.partB === opt, qData.partB.answer === opt)).join('');
                    answerContent = `
                        <h4 style="font-weight: 600; margin-bottom: 8px;">Part A: ${qData.partA.question}</h4>
                        ${partA_html}
                        <h4 style="font-weight: 600; margin-top: 16px; margin-bottom: 8px;">Part B: ${qData.partB.question}</h4>
                        ${partB_html}
                    `;
                    break;
                case 'te_hotspot':
                    const tempGrid = renderCoordinateGrid(sourceText.dataPoints, false, studentAnswer, 'source-grid');
                    answerContent = `
                        <p>Student selected: <strong>${studentAnswer || 'Unanswered'}</strong>. Correct answer: <strong>${qData.answer}</strong></p>
                        ${tempGrid}
                    `;
                    break;
            }

            reportContainer.innerHTML = `
                <div style="padding: 10px; border: 1px solid #ccc; background-color: #f9f9f9;">
                    <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem; border-bottom: 1px solid #ddd; padding-bottom: 0.5rem;">Question ${i + 1}</h3>
                    <p style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem;">${qData.question || qData.partA.question}</p>
                    <div>${answerContent}</div>
                </div>
            `;
            
            document.body.appendChild(reportContainer);
            
            const canvas = await html2canvas(reportContainer, { scale: 2 });
            const imgData = canvas.toDataURL('image/png');
            const imgProps = pdf.getImageProperties(imgData);
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

            if (i > 0) {
                pdf.addPage();
            }
            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
            
            document.body.removeChild(reportContainer);
        }
        
        document.body.removeChild(loadingOverlay);
        pdf.save('math_detective_report.pdf');
    };
    
    const updateProgressBar = () => {
        const percentage = ((appState.currentQuestionIndex + 1) / assessmentQuestions.length) * 100;
        progressBar.style.width = `${percentage}%`;
        progressLabel.textContent = `Case File: ${appState.currentQuestionIndex + 1} of ${assessmentQuestions.length}`;
    };

    const showView = (viewId) => {
        Object.values(views).forEach(v => v.classList.add('hidden'));
        if (views[viewId]) views[viewId].classList.remove('hidden');
        appHeader.classList.toggle('hidden', viewId === 'home' || viewId === 'confirmation' || viewId === 'score');
        appState.currentView = viewId;
    };

    const renderSourceText = () => {
        const graphHtml = renderCoordinateGrid(sourceText.dataPoints, false, null, 'source-grid');
        sourceTextContainer.innerHTML = `
            <p class="mb-4 text-gray-300">${sourceText.body}</p>
            <p class="mb-4 text-gray-300">${sourceText.conclusion}</p>
            <div class="flex justify-center items-center mt-4">
                ${graphHtml}
            </div>
        `;
    };

    const renderQuestion = () => {
        const qIndex = appState.currentQuestionIndex;
        const qData = assessmentQuestions[qIndex];
        renderSourceText();
        
        let answerHtml = '';
        const savedAnswer = appState.studentAnswers[qIndex];

        switch (qData.type) {
            case 'mc':
                answerHtml = qData.options.map(opt => `
                    <label class="block border rounded-lg p-3 mb-2 cursor-pointer hover:bg-yellow-100 ${savedAnswer === opt ? 'bg-yellow-200 border-yellow-400' : 'bg-gray-50'}">
                        <input type="radio" name="q${qIndex}" value="${opt}" class="mr-2" ${savedAnswer === opt ? 'checked' : ''} > ${opt}
                    </label>`).join('');
                break;
            case 'ms':
                 answerHtml = qData.options.map(opt => `
                    <label class="block border rounded-lg p-3 mb-2 cursor-pointer hover:bg-yellow-100 ${savedAnswer?.includes(opt) ? 'bg-yellow-200 border-yellow-400' : 'bg-gray-50'}">
                        <input type="checkbox" name="q${qIndex}" value="${opt}" class="mr-2" ${savedAnswer?.includes(opt) ? 'checked' : ''} > ${opt}
                    </label>`).join('');
                break;
            case 'te_hotspot':
                answerHtml = renderCoordinateGrid(sourceText.dataPoints, true, savedAnswer, '');
                break;
            case 'ebsr':
                 answerHtml = `
                    <div class="mb-4">
                        <p class="font-semibold mb-2">Part A: ${qData.partA.question}</p>
                        ${qData.partA.options.map(opt => `<label class="block border rounded-lg p-3 mb-2 cursor-pointer hover:bg-yellow-100 ${savedAnswer?.partA === opt ? 'bg-yellow-200 border-yellow-400' : 'bg-gray-50'}"><input type="radio" name="q${qIndex}_partA" value="${opt}" class="mr-2" ${savedAnswer?.partA === opt ? 'checked' : ''} >${opt}</label>`).join('')}
                    </div>
                    <div>
                        <p class="font-semibold mb-2">Part B: ${qData.partB.question}</p>
                        ${qData.partB.options.map(opt => `<label class="block border rounded-lg p-3 mb-2 cursor-pointer hover:bg-yellow-100 ${savedAnswer?.partB === opt ? 'bg-yellow-200 border-yellow-400' : 'bg-gray-50'}"><input type="radio" name="q${qIndex}_partB" value="${opt}" class="mr-2" ${savedAnswer?.partB === opt ? 'checked' : ''} >${opt}</label>`).join('')}
                    </div>`;
                break;
        }

        questionContainer.innerHTML = `
            <div class="flex-grow overflow-y-auto pr-2">
                <p class="text-sm text-gray-500 mb-1">Question ${qIndex + 1} of ${assessmentQuestions.length}</p>
                <h3 class="text-xl font-semibold mb-4">${qData.question || qData.partA.question}</h3>
                <div>${answerHtml}</div>
            </div>
            <div class="mt-6 flex justify-between items-center pt-4 border-t">
                <button id="prev-btn" class="btn-secondary font-bold py-2 px-6 rounded-lg ${qIndex === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${qIndex === 0 ? 'disabled' : ''}>Previous</button>
                <button id="next-btn" class="btn-primary font-bold py-2 px-6 rounded-lg">${qIndex === assessmentQuestions.length - 1 ? 'Finish Case' : 'Next'}</button>
            </div>`;
        updateProgressBar();
        addQuestionEventListeners();
    };
    
    const saveAnswer = () => {
        const qIndex = appState.currentQuestionIndex;
        const qData = assessmentQuestions[qIndex];
        let answer;
        switch (qData.type) {
            case 'mc':
                answer = questionContainer.querySelector(`input[name="q${qIndex}"]:checked`)?.value || null;
                break;
            case 'ms':
                answer = Array.from(questionContainer.querySelectorAll(`input[name="q${qIndex}"]:checked`)).map(el => el.value);
                break;
            case 'te_hotspot':
                answer = questionContainer.querySelector('.grid-point.selected')?.dataset.coord || null;
                break;
            case 'ebsr':
                answer = {
                    partA: questionContainer.querySelector(`input[name="q${qIndex}_partA"]:checked`)?.value || null,
                    partB: questionContainer.querySelector(`input[name="q${qIndex}_partB"]:checked`)?.value || null
                };
                break;
        }
        appState.studentAnswers[qIndex] = answer;
        localStorage.setItem('mathDetectiveProgress', JSON.stringify(appState.studentAnswers));
    };

    const renderScoreView = () => {
        let correctCount = 0;
        assessmentQuestions.forEach((q, i) => {
            const studentAnswer = appState.studentAnswers[i];
            let isCorrect = false;
            switch(q.type) {
                case 'mc':
                case 'te_hotspot':
                    isCorrect = studentAnswer === q.answer;
                    break;
                case 'ms':
                    if (studentAnswer && studentAnswer.length === q.answer.length) {
                        isCorrect = q.answer.every(val => studentAnswer.includes(val));
                    }
                    break;
                case 'ebsr':
                    isCorrect = studentAnswer?.partA === q.partA.answer && studentAnswer?.partB === q.partB.answer;
                    break;
            }
            if(isCorrect) correctCount++;
        });

        document.getElementById('score-display').innerHTML = `
            <p class="text-xl text-gray-300">Your final score is:</p>
            <p class="text-8xl font-bold text-green-400 my-4">${correctCount}<span class="text-4xl text-gray-400"> / ${assessmentQuestions.length}</span></p>
        `;

        localStorage.setItem('mathDetectiveLocked', 'true'); // Lock the state
    };
    
    function addQuestionEventListeners() {
        document.getElementById('prev-btn')?.addEventListener('click', () => {
            saveAnswer();
            if (appState.currentQuestionIndex > 0) {
                appState.currentQuestionIndex--;
                renderQuestion();
            }
        });
        document.getElementById('next-btn')?.addEventListener('click', () => {
            saveAnswer();
            if (appState.currentQuestionIndex < assessmentQuestions.length - 1) {
                appState.currentQuestionIndex++;
                renderQuestion();
            } else {
                showView('confirmation');
            }
        });

        // Hotspot listener
        if (assessmentQuestions[appState.currentQuestionIndex].type === 'te_hotspot') {
            document.querySelectorAll('.hotspot').forEach(spot => {
                spot.addEventListener('click', () => {
                    document.querySelectorAll('.hotspot').forEach(s => s.classList.remove('selected'));
                    spot.classList.add('selected');
                });
            });
        }
    }

    document.getElementById('start-test-btn').addEventListener('click', () => {
        appState.mode = 'test';
        appState.currentQuestionIndex = 0;
        showView('assessment');
        renderQuestion();
    });

    // Dummy listener for practice button
     document.getElementById('start-practice-btn').addEventListener('click', () => {
        alert("Practice Center for this topic is under construction!");
    });
    
    document.getElementById('home-btn').addEventListener('click', () => {
        saveAnswer();
        showView('home');
    });

    document.getElementById('final-review-btn').addEventListener('click', () => {
        appState.currentQuestionIndex = 0;
        showView('assessment');
        renderQuestion();
    });

    document.getElementById('final-submit-btn').addEventListener('click', () => {
        renderScoreView();
        showView('score');
    });

    const init = () => {
        // Check if student is locked into score view
        if (localStorage.getItem('mathDetectiveLocked') === 'true') {
            const lsData = localStorage.getItem('mathDetectiveProgress');
            if (lsData) appState.studentAnswers = JSON.parse(lsData);
            renderScoreView();
            showView('score');
            return;
        }

        // Load progress from <script> tag or localStorage
        try {
            const progressDataEl = document.getElementById('progress-data');
            const data = progressDataEl?.textContent.trim();
            if (data && data.length > 2) {
                appState.studentAnswers = JSON.parse(data);
            } else {
                const lsData = localStorage.getItem('mathDetectiveProgress');
                if (lsData) appState.studentAnswers = JSON.parse(lsData);
            }
        } catch (e) { console.error("Failed to load progress", e); }
        
        showView('home');
    };
    
    // Simplified PDF generation and other listeners for brevity.
    // Full functionality for password modal, saving, etc. would be similar to the previous version.
    document.getElementById('password-submit').addEventListener('click', () => {
        if(document.getElementById('password-input').value === '2026') {
             passwordModal.classList.add('hidden');
             document.getElementById('password-input').value = '';
             document.getElementById('password-error').classList.add('hidden');
             // Admin Reset Logic
             localStorage.removeItem('mathDetectiveProgress');
             localStorage.removeItem('mathDetectiveLocked');
             appState.studentAnswers = {};
             appState.currentQuestionIndex = 0;
             showView('home');
        } else {
            document.getElementById('password-error').classList.remove('hidden');
        }
    });
    document.getElementById('admin-reset-link').addEventListener('click', (e) => { e.preventDefault(); passwordModal.classList.remove('hidden'); });
    document.getElementById('password-cancel').addEventListener('click', () => passwordModal.classList.add('hidden'));
    document.getElementById('download-work-btn').addEventListener('click', downloadWorkFile);
    document.getElementById('download-pdf-btn').addEventListener('click', downloadPdfReport);

    init();
});
</script>

</body>
</html>

