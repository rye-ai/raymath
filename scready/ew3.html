<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Two Myths: An Analysis of Plot and Character</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Lato', sans-serif;
            background-color: #F8F0E3; /* Papyrus Cream */
            color: #333;
        }
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Merriweather', serif;
        }
        .theme-bg { background-color: #F8F0E3; }
        .theme-primary { color: #003366; } /* Deep Blue */
        .theme-secondary { color: #CD7F32; } /* Bronze */
        .theme-accent { background-color: #003366; }
        .theme-accent-text { color: white; }
        .btn {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .view {
            display: none;
            animation: fadeIn 0.5s;
        }
        .view.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        /* Styles for selected answers */
        .selected-option {
            background-color: #D1E7FD !important;
            border-color: #003366 !important;
        }
        .hot-text-selected {
            background-color: #ffeb3b;
            border-radius: 4px;
            padding: 2px;
            cursor: pointer;
        }
         .hot-text-clickable {
            cursor: pointer;
            padding: 2px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .hot-text-clickable:hover {
            background-color: #fff2a8;
        }
        /* Print styles for PDF generation */
        .print-container {
            font-family: 'Times New Roman', serif;
            background-color: white;
            color: black;
            padding: 20px;
            border: 1px solid #ccc;
            margin-bottom: 20px;
        }
        .print-container h3 {
            font-size: 16pt;
            font-weight: bold;
        }
        .print-container p, .print-container li {
            font-size: 12pt;
        }
        .print-passage {
            background-color: #f5f5f5;
            border-left: 3px solid #ccc;
            padding: 10px;
            margin-bottom: 15px;
        }
        .print-answer-selected {
            background-color: #e0e0e0;
            font-weight: bold;
            padding: 5px;
            border-radius: 3px;
        }
        .print-hot-text-selected {
             background-color: #e0e0e0;
             font-weight: bold;
        }
    </style>
</head>
<body class="theme-bg">

    <!-- Header -->
    <header class="theme-accent text-white p-4 shadow-md sticky top-0 z-50 flex justify-between items-center">
        <h1 class="text-xl md:text-2xl font-bold">Two Myths: An Analysis</h1>
        <div id="header-buttons">
            <button id="home-btn" class="theme-accent-text font-bold py-2 px-4 rounded hover:bg-white hover:text-gray-800">Home</button>
        </div>
    </header>

    <main id="app-container" class="p-4 md:p-8 max-w-7xl mx-auto">
        <!-- Home View -->
        <div id="home-view" class="view active text-center">
            <div class="bg-white/80 p-8 rounded-lg shadow-xl backdrop-blur-sm">
                <h2 class="text-4xl font-bold theme-primary mb-2">Analysis of Two Myths</h2>
                <p class="text-lg text-gray-700 mb-8">An interactive lesson on setting, character, and plot.</p>
                <div class="space-y-4 md:space-y-0 md:space-x-4">
                    <button id="start-test-btn" class="btn theme-accent theme-accent-text text-xl font-bold py-4 px-8 rounded-lg shadow-lg w-full md:w-auto">Take the Test</button>
                    <button id="start-practice-btn" class="btn bg-white border-2 border-stone-400 text-stone-600 text-xl font-bold py-4 px-8 rounded-lg shadow-lg w-full md:w-auto">Go to Practice Center</button>
                </div>
            </div>
        </div>

        <!-- Test View -->
        <div id="test-view" class="view">
            <div id="test-progress-bar-container" class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
                <div id="test-progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
            </div>
            <div class="flex justify-between items-center mb-4">
                <h2 id="test-question-counter" class="text-xl font-bold theme-primary">Question 1 of 10</h2>
                <div>
                     <button id="download-work-btn" class="btn bg-gray-500 text-white text-sm font-bold py-1 px-3 rounded-md">Download Work</button>
                     <button id="export-pdf-btn" class="btn bg-red-700 text-white text-sm font-bold py-1 px-3 rounded-md">Download as PDF</button>
                </div>
            </div>
            <div id="test-content" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Source Text Column -->
                <div id="source-text-container" class="bg-white/80 p-6 rounded-lg shadow-lg overflow-y-auto max-h-[75vh]">
                    <!-- Passage text will be injected here -->
                </div>

                <!-- Question Column -->
                <div id="question-container" class="bg-white/80 p-6 rounded-lg shadow-lg">
                    <!-- Question content will be injected here -->
                </div>
            </div>
            <div id="test-navigation" class="mt-6 flex justify-between">
                <button id="test-prev-btn" class="btn bg-gray-300 text-gray-700 font-bold py-2 px-6 rounded-lg">Previous</button>
                <button id="test-next-btn" class="btn theme-accent theme-accent-text font-bold py-2 px-6 rounded-lg">Next</button>
            </div>
        </div>
        
        <!-- Practice Center View -->
        <div id="practice-view" class="view">
             <div class="bg-white/80 p-8 rounded-lg shadow-xl backdrop-blur-sm max-w-3xl mx-auto">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold theme-primary">Practice Center</h2>
                    <p id="practice-counter" class="text-lg font-semibold text-gray-600">1 / 20</p>
                </div>
                <div id="practice-content" class="min-h-[200px]">
                    <!-- Practice activity content will be injected here -->
                </div>
                <div id="practice-feedback" class="mt-4 text-center text-xl font-bold h-8"></div>
                <div class="mt-4 flex justify-center items-center space-x-4">
                    <button id="practice-check-btn" class="btn theme-accent theme-accent-text font-bold py-3 px-8 rounded-lg">Check Answer</button>
                    <button id="practice-try-again-btn" class="btn bg-yellow-500 text-white font-bold py-3 px-8 rounded-lg hidden">Try Again</button>
                    <button id="practice-next-btn" class="btn bg-green-600 text-white font-bold py-3 px-8 rounded-lg hidden">Next</button>
                </div>
            </div>
        </div>

        <!-- Confirmation View -->
        <div id="confirmation-view" class="view text-center">
            <div class="bg-white/80 p-8 rounded-lg shadow-xl backdrop-blur-sm max-w-lg mx-auto">
                <h2 class="text-3xl font-bold theme-primary mb-4">Ready to submit your findings?</h2>
                <p class="text-gray-700 mb-8">Once you submit, your test will be graded and you will not be able to change your answers.</p>
                <div class="flex justify-center space-x-4">
                    <button id="review-answers-btn" class="btn bg-gray-300 text-gray-700 font-bold py-3 px-6 rounded-lg">Review Answers</button>
                    <button id="submit-grading-btn" class="btn theme-accent theme-accent-text font-bold py-3 px-6 rounded-lg">Submit for Grading</button>
                </div>
            </div>
        </div>

        <!-- Score View -->
        <div id="score-view" class="view text-center">
            <div class="bg-white/80 p-8 rounded-lg shadow-xl backdrop-blur-sm max-w-lg mx-auto">
                <h2 class="text-2xl font-bold theme-primary mb-2">Test Complete!</h2>
                <p class="text-lg text-gray-600 mb-4">Here is your final score:</p>
                <p id="final-score" class="text-7xl font-bold theme-secondary my-6">0 / 10</p>
                <p class="text-gray-700">All test navigation is now locked.</p>
                <button id="admin-reset-btn" class="text-xs text-gray-400 hover:text-gray-600 mt-8">Admin Reset</button>
            </div>
        </div>

        <!-- PDF Staging Area (Hidden) -->
        <div id="pdf-staging-area" class="absolute -left-[9999px] top-auto w-[800px] overflow-auto"></div>

    </main>

    <script id="progress-data" type="application/json"></script>
    
    <script>
    // --- DATA & STATE MANAGEMENT ---

    const sourceTexts = {
        icarus: {
            title: "The Flight of Icarus",
            paragraphs: [
                "<strong>Paragraph 1:</strong> Daedalus, a brilliant inventor, found himself a prisoner on the island of Crete. King Minos, the island's ruler, had tasked him with building a great Labyrinth, a maze so complex that none could escape. After the work was done, the king, fearing Daedalus would share its secrets, imprisoned the inventor and his young son, Icarus, within a tall tower overlooking the sea. The tower was secure, and the shores were heavily guarded. For Daedalus, the land and sea were barred, but the sky remained open.",
                "<strong>Paragraph 2:</strong> Day after day, Daedalus watched the gulls dip and soar on the ocean winds. An idea, as bold as it was brilliant, took root in his mind. 'We may not walk or sail away,' he told Icarus, 'but we can fly.' He began to gather feathers dropped by the seabirds, tying them together with thread and molding them with warm wax. He crafted two pairs of magnificent wings, curving them just like a bird's.",
                "<strong>Paragraph 3:</strong> When the wings were complete, Daedalus fastened one pair to his son's shoulders. 'Listen closely, Icarus,' he warned, his voice firm but full of concern. 'Follow me, and do not stray. If you fly too low, the damp sea spray will weigh down your wings. If you fly too high, the sun's heat will melt the wax.' Icarus, filled with a thrilling sense of freedom, nodded eagerly, his heart pounding with excitement for the journey ahead.",
                "<strong>Paragraph 4:</strong> Daedalus leaped from the tower window, his great wings catching the air. Icarus followed, laughing with delight as he felt himself lifted from the earth. Below them, the island of Crete shrank to a speck. Farmers in their fields and fishermen in their boats looked up in astonishment, mistaking the pair for gods. The feeling was intoxicating, and Icarus, forgetting his father's solemn warning, began to feel a surge of reckless pride.",
                "<strong>Paragraph 5:</strong> He wanted to soar higher, to touch the heavens. He left his father's safe path and began to climb, up, up, toward the blazing sun. The warm air felt wonderful on his face. But soon, the nearness of the sun began to soften the wax that held his feathers. One by one, the feathers loosened and drifted away. Icarus flapped his arms frantically, but there was nothing to catch the wind. With a cry of terror, he plunged downward, into the vast, unforgiving sea below. Daedalus, heartbroken, could only watch as his son disappeared into the waves. He named the sea where his son fell the Icarian Sea, a sad monument to a boy who flew too close to the sun."
            ]
        },
        arachne: {
            title: "The Weaver's Challenge",
            paragraphs: [
                 "<strong>Paragraph 1:</strong> In a small village in ancient Greece lived a young woman named Arachne, who was famous for her incredible skill in weaving. The tapestries she created were so beautiful and lifelike that people would travel from miles around just to see them. Arachne was proud of her work, and rightly so. However, her pride grew into arrogance. She began to boast that her skill was even greater than that of Athena, the goddess of wisdom and craft, who was said to have invented the loom.",
                 "<strong>Paragraph 2:</strong> Word of Arachne's boasting reached Mount Olympus, and Athena was displeased. The goddess decided to visit Arachne in disguise, appearing as an old woman leaning on a staff. 'You have a great gift,' the old woman said softly, 'but it is unwise to compare yourself to the gods. You should ask the goddess Athena for forgiveness.' Arachne scoffed. 'I do not need her forgiveness! If Athena thinks she is so skilled, let her come and challenge me herself!'",
                 "<strong>Paragraph 3:</strong> With those words, the old woman’s disguise fell away, revealing the powerful goddess Athena in her full glory. Her eyes flashed with anger. 'You have your challenge!' she declared. The villagers gasped, but Arachne’s pride would not let her back down. A weaving contest was arranged. Two looms were set up, and the contest began. Athena wove a magnificent tapestry showing the power of the gods and the fates of mortals who dared to defy them. It was a masterpiece, but it was also a warning.",
                 "<strong>Paragraph 4:</strong> Arachne, in her defiance, wove a tapestry that showed the gods in a negative light, highlighting their mistakes and follies. Her work was technically flawless, every thread perfect, every image breathtakingly real. But the subject was a direct insult to Athena. When she was finished, Athena could find no fault with the skill of the weaving, which only enraged her further. The goddess tore Arachne's tapestry to shreds and struck the girl on the forehead.",
                 "<strong>Paragraph 5:</strong> Overcome with shame and despair, Arachne fled. But Athena was not finished. 'You want to weave forever?' the goddess said, her voice echoing with power. 'Then you shall!' She touched Arachne, and the girl's body began to shrink and change. Her arms and legs grew long and spindly, and she was transformed into the world's first spider. And from that day on, Arachne and her descendants were doomed to spend all their days weaving webs, a constant reminder of the price of pride."
            ]
        }
    };

    const assessmentQuestions = [
        // Passage 1: The Flight of Icarus
        {
            id: 'q1',
            type: 'mc',
            dok: 2,
            stem: "Which statement best describes the main conflict for Daedalus in paragraph 1?",
            options: [
                "He dislikes King Minos and wants to leave the island.",
                "He is a brilliant inventor but cannot figure out how to build the Labyrinth.",
                "He and his son are physically trapped, but he sees a potential escape route.",
                "He is worried that his son Icarus will not be able to fly."
            ],
            correctAnswer: "He and his son are physically trapped, but he sees a potential escape route."
        },
        {
            id: 'q2',
            type: 'mc',
            dok: 1,
            stem: "According to paragraph 3, what specific warning does Daedalus give Icarus about flying too high?",
            options: [
                "The winds will be too strong.",
                "He will get lost in the clouds.",
                "The sun's heat will melt the wax.",
                "The gods will become angry."
            ],
            correctAnswer: "The sun's heat will melt the wax."
        },
        {
            id: 'q3',
            type: 'mc',
            dok: 2,
            stem: "How does the setting of the 'tall tower overlooking the sea' in paragraph 1 impact the plot?",
            options: [
                "It proves that King Minos is a kind ruler.",
                "It allows Daedalus to observe the birds and develop his plan of escape.",
                "It makes it easy for Daedalus and Icarus to gather feathers.",
                "It provides a safe place for them to live happily."
            ],
            correctAnswer: "It allows Daedalus to observe the birds and develop his plan of escape."
        },
        {
            id: 'q4',
            type: 'mc',
            dok: 3,
            stem: "Which statement best analyzes how Icarus's character development moves the plot toward its climax?",
            options: [
                "Icarus changes from excited to cautious, which is shown when he tries to fly lower to avoid the sun.",
                "Icarus becomes angry at his father, which is shown when he decides to fly on his own path.",
                "Icarus changes from obedient to reckless, which is shown when he forgets his father's warning and feels 'a surge of reckless pride.'",
                "Icarus grows more skillful, which is shown by the fact that the farmers and fishermen mistake him for a god."
            ],
            correctAnswer: "Icarus changes from obedient to reckless, which is shown when he forgets his father's warning and feels 'a surge of reckless pride.'"
        },
        {
            id: 'q5',
            type: 'mc',
            dok: 3,
            stem: "Which sentence best analyzes how the conflict leads to the story's tragic conclusion in paragraph 5?",
            options: [
                "Daedalus's external conflict with King Minos causes him to build wings that are faulty.",
                "The beautiful setting of the sky makes Icarus forget that he is in danger.",
                "Icarus's internal conflict between obedience and pride leads him to ignore a warning that results in his doom.",
                "The fishermen's conflict with their daily work prevents them from helping Icarus."
            ],
            correctAnswer: "Icarus's internal conflict between obedience and pride leads him to ignore a warning that results in his doom."
        },
        // Passage 2: The Weaver's Challenge
        {
            id: 'q6',
            type: 'mc',
            dok: 2,
            stem: "In paragraph 1, what does Arachne's boasting reveal about her primary character trait?",
            options: [
                "She is shy and does not like attention.",
                "She is arrogant and overly proud of her abilities.",
                "She is a kind teacher to other weavers.",
                "She is secretly afraid of the goddess Athena."
            ],
            correctAnswer: "She is arrogant and overly proud of her abilities."
        },
        {
            id: 'q7',
            type: 'mc',
            dok: 2,
            stem: "Which event from the story creates the main conflict between Arachne and Athena?",
            options: [
                "Villagers travel from miles around to see Arachne's work.",
                "Athena visits Arachne disguised as an old woman.",
                "Arachne refuses to ask for forgiveness and challenges Athena to a contest.",
                "Athena weaves a tapestry showing the power of the gods."
            ],
            correctAnswer: "Arachne refuses to ask for forgiveness and challenges Athena to a contest."
        },
        {
            id: 'q8',
            type: 'hot-text',
            dok: 2,
            stem: "Click on the sentence in paragraph 4 that shows the specific detail that turns Athena's displeasure into rage.",
            sentence: "Arachne, in her defiance, wove a tapestry that showed the gods in a negative light, highlighting their mistakes and follies. Her work was technically flawless, every thread perfect, every image breathtakingly real. But the subject was a direct insult to Athena. When she was finished, Athena could find no fault with the skill of the weaving, which only enraged her further. The goddess tore Arachne's tapestry to shreds and struck the girl on the forehead.",
            correctAnswer: "When she was finished, Athena could find no fault with the skill of the weaving, which only enraged her further."
        },
        {
            id: 'q9',
            type: 'mc',
            dok: 3,
            stem: "How do the descriptions of the two tapestries in paragraphs 3 and 4 help develop the plot?",
            options: [
                "They show that both weavers are equally good, so the contest is a tie.",
                "They reveal the different perspectives of the characters, with Athena's being a warning and Arachne's an insult, escalating the conflict.",
                "They describe beautiful works of art that make the villagers happy.",
                "They prove that the gods make many mistakes and that Arachne is right."
            ],
            correctAnswer: "They reveal the different perspectives of the characters, with Athena's being a warning and Arachne's an insult, escalating the conflict."
        },
        {
            id: 'q10',
            type: 'mc',
            dok: 3,
            stem: "How does Arachne's central character trait lead to her transformation at the end of the story?",
            options: [
                "Her creativity allows her to imagine herself as a spider.",
                "Her kindness impresses Athena, who gives her a new form.",
                "Her ambition to be the best weaver is granted in a twisted, literal way.",
                "Her pride prevents her from backing down or showing respect, which results in a divine punishment."
            ],
            correctAnswer: "Her pride prevents her from backing down or showing respect, which results in a divine punishment."
        }
    ];

    const practiceActivities = [
        { type: 'mc', question: 'A story takes place in a dark, spooky forest. This primarily describes the story\'s...', options: ['Character', 'Setting', 'Conflict'], answer: 'Setting' },
        { type: 'mc', question: 'A character is trying to decide whether to tell the truth or lie. This is an example of...', options: ['Internal Conflict', 'External Conflict', 'Plot Development'], answer: 'Internal Conflict' },
        { type: 'hot-text', sentence: 'Maria felt a shiver of dread creep up her spine as she opened the mysterious door.', instruction: 'Click the phrase that reveals the character\'s feeling.', answer: 'a shiver of dread' },
        { type: 'mc', question: 'The main problem that a character faces is the...', options: ['Setting', 'Theme', 'Conflict'], answer: 'Conflict' },
        { type: 'mc', question: 'The rising action of a story leads up to the...', options: ['Exposition', 'Climax', 'Resolution'], answer: 'Climax' },
        { type: 'mc', question: 'A story set on a desert island would most likely feature a conflict of...', options: ['Character vs. Society', 'Character vs. Nature', 'Character vs. Technology'], answer: 'Character vs. Nature' },
        { type: 'mc', question: 'A character\'s reason for doing something is called their...', options: ['Trait', 'Motivation', 'Action'], answer: 'Motivation' },
        { type: 'hot-text', sentence: 'The blistering sun beat down on the cracked, dry earth.', instruction: 'Click the phrase that describes the setting.', answer: 'blistering sun' },
        { type: 'mc', question: 'How a character feels or acts can influence the story\'s...', options: ['Punctuation', 'Plot', 'Author'], answer: 'Plot' },
        { type: 'mc', question: 'Which of these is a character trait?', options: ['Running', 'Brave', 'Shouting'], answer: 'Brave' },
        { type: 'mc', question: 'A struggle between two characters is an example of...', options: ['Internal Conflict', 'External Conflict', 'Setting'], answer: 'External Conflict' },
        { type: 'hot-text', sentence: 'Even though he was terrified, Leo knew he had to face the dragon to save his village.', instruction: 'Click the phrase that shows an internal conflict.', answer: 'he was terrified' },
        { type: 'mc', question: 'The sequence of events in a story is called the...', options: ['Plot', 'Theme', 'Setting'], answer: 'Plot' },
        { type: 'mc', question: 'If a story takes place in the future on Mars, the setting directly impacts the...', options: ['Character names', 'Types of problems characters face', 'Story\'s font'], answer: 'Types of problems characters face' },
        { type: 'mc', question: 'Which is an example of a setting?', options: ['A haunted house at midnight', 'A girl who is very clever', 'A dangerous journey'], answer: 'A haunted house at midnight' },
        { type: 'hot-text', sentence: 'Her ambition was a fire that could not be quenched.', instruction: 'Click the word that is a character trait.', answer: 'ambition' },
        { type: 'mc', question: 'A character being shipwrecked by a storm is an example of how setting can create...', options: ['Character', 'Conflict', 'Theme'], answer: 'Conflict' },
        { type: 'mc', question: 'The final outcome of the story\'s conflict is the...', options: ['Rising Action', 'Exposition', 'Resolution'], answer: 'Resolution' },
    ];

    // --- APPLICATION STATE ---
    let currentTestQuestionIndex = 0;
    let currentPracticeItemIndex = 0;
    let studentAnswers = {};
    let testState = {
        isLocked: false,
        score: null
    };

    // --- DOM ELEMENTS ---
    const views = {
        home: document.getElementById('home-view'),
        test: document.getElementById('test-view'),
        practice: document.getElementById('practice-view'),
        confirmation: document.getElementById('confirmation-view'),
        score: document.getElementById('score-view')
    };
    const questionContainer = document.getElementById('question-container');
    const sourceTextContainer = document.getElementById('source-text-container');
    const testProgressBar = document.getElementById('test-progress-bar');
    const testQuestionCounter = document.getElementById('test-question-counter');

    // --- APPLICATION LOGIC ---
    
    document.addEventListener('DOMContentLoaded', () => {
        // Hydration Logic
        const progressDataEl = document.getElementById('progress-data');
        let loadedData = null;

        if (progressDataEl && progressDataEl.textContent.trim().length > 2) {
            try {
                loadedData = JSON.parse(progressDataEl.textContent);
            } catch (e) { console.error("Could not parse progress data from script tag.", e); }
        } else {
            const lsAnswers = localStorage.getItem('studentAnswers');
            const lsState = localStorage.getItem('testState');
            if (lsAnswers && lsState) {
                loadedData = {
                    answers: JSON.parse(lsAnswers),
                    state: JSON.parse(lsState)
                };
            }
        }

        if (loadedData) {
            studentAnswers = loadedData.answers || {};
            testState = loadedData.state || { isLocked: false, score: null };
        }

        if (testState.isLocked) {
            displayScore();
            showView('score');
        } else {
            showView('home');
        }

        setupEventListeners();
    });

    function setupEventListeners() {
        document.getElementById('home-btn').addEventListener('click', () => {
             if (!testState.isLocked) showView('home');
        });
        document.getElementById('start-test-btn').addEventListener('click', startTest);
        document.getElementById('start-practice-btn').addEventListener('click', startPractice);
        document.getElementById('test-next-btn').addEventListener('click', nextTestQuestion);
        document.getElementById('test-prev-btn').addEventListener('click', prevTestQuestion);
        document.getElementById('review-answers-btn').addEventListener('click', reviewAnswers);
        document.getElementById('submit-grading-btn').addEventListener('click', submitForGrading);
        document.getElementById('admin-reset-btn').addEventListener('click', adminReset);
        document.getElementById('download-work-btn').addEventListener('click', downloadWork);
        document.getElementById('export-pdf-btn').addEventListener('click', downloadPDF);
        document.getElementById('practice-check-btn').addEventListener('click', checkPracticeAnswer);
        document.getElementById('practice-try-again-btn').addEventListener('click', tryPracticeAgain);
        document.getElementById('practice-next-btn').addEventListener('click', nextPracticeItem);
    }
    
    function showView(viewId) {
        Object.values(views).forEach(view => view.classList.remove('active'));
        if (views[viewId]) {
            views[viewId].classList.add('active');
        } else {
            console.error(`View with id ${viewId} not found.`);
        }
    }

    // --- TEST LOGIC ---

    function startTest() {
        currentTestQuestionIndex = 0;
        renderTestQuestion();
        showView('test');
    }

    function renderPassage() {
        const passageKey = currentTestQuestionIndex < 5 ? 'icarus' : 'arachne';
        const passage = sourceTexts[passageKey];
        let html = `<h3 class="text-2xl font-bold theme-primary mb-4">${passage.title}</h3>
                    <div class="space-y-4 text-gray-800 leading-relaxed">`;
        passage.paragraphs.forEach(p => {
            html += `<p>${p}</p>`;
        });
        html += `</div>`;
        sourceTextContainer.innerHTML = html;
        sourceTextContainer.scrollTop = 0;
    }

    function renderTestQuestion() {
        if (testState.isLocked) return;

        renderPassage();
        
        const question = assessmentQuestions[currentTestQuestionIndex];
        let html = `<h3 class="text-xl font-bold theme-primary mb-4">Question ${currentTestQuestionIndex + 1}${question.part ? `, Part ${question.part}` : ''}</h3>`;
        html += `<p class="text-gray-800 mb-6">${question.stem}</p>`;
        
        const savedAnswer = studentAnswers[question.id];

        switch (question.type) {
            case 'mc':
                html += '<div class="space-y-3">';
                question.options.forEach(option => {
                    const isChecked = savedAnswer === option;
                    html += `
                        <label class="flex items-center p-3 border-2 rounded-lg cursor-pointer hover:bg-gray-100 ${isChecked ? 'selected-option' : 'border-gray-200'}">
                            <input type="radio" name="q_${question.id}" value="${escapeHTML(option)}" class="mr-3" ${isChecked ? 'checked' : ''}>
                            <span>${escapeHTML(option)}</span>
                        </label>`;
                });
                html += '</div>';
                break;
            case 'hot-text':
                const sentences = question.sentence.split(/(?<=[.?!])\s+/);
                html += `<div class="p-4 bg-gray-100 rounded-lg space-y-2">`;
                sentences.forEach(s => {
                    const isSelected = savedAnswer === s;
                    html += `<span class="hot-text-clickable ${isSelected ? 'hot-text-selected' : ''}" data-sentence="${escapeHTML(s)}">${escapeHTML(s)} </span>`;
                });
                html += `</div>`;
                break;
        }

        questionContainer.innerHTML = html;
        addQuestionSpecificListeners();
        updateTestNavigation();
    }

    function addQuestionSpecificListeners() {
        const question = assessmentQuestions[currentTestQuestionIndex];
        switch (question.type) {
            case 'mc':
                document.querySelectorAll(`input[name="q_${question.id}"]`).forEach(input => {
                    input.addEventListener('change', (e) => saveAnswer(question.id, e.target.value));
                });
                break;
            case 'hot-text':
                 document.querySelectorAll('.hot-text-clickable').forEach(span => {
                    span.addEventListener('click', (e) => {
                        document.querySelectorAll('.hot-text-clickable').forEach(el => el.classList.remove('hot-text-selected'));
                        e.target.classList.add('hot-text-selected');
                        saveAnswer(question.id, e.target.dataset.sentence);
                    });
                 });
                break;
        }
    }

    function saveAnswer(questionId, answer) {
        studentAnswers[questionId] = answer;
        localStorage.setItem('studentAnswers', JSON.stringify(studentAnswers));
        
        if (document.querySelector(`input[name="q_${questionId}"]`)) {
            document.querySelectorAll(`label:has(input[name="q_${questionId}"])`).forEach(label => {
                label.classList.remove('selected-option');
            });
            const selectedInput = document.querySelector(`input[name="q_${questionId}"]:checked`);
            if (selectedInput) {
                selectedInput.closest('label').classList.add('selected-option');
            }
        }
    }
    
    function updateTestNavigation() {
        document.getElementById('test-prev-btn').style.visibility = (currentTestQuestionIndex === 0) ? 'hidden' : 'visible';
        
        const nextBtn = document.getElementById('test-next-btn');
        nextBtn.textContent = (currentTestQuestionIndex === assessmentQuestions.length - 1) ? 'Finish' : 'Next';
        
        const progress = ((currentTestQuestionIndex + 1) / assessmentQuestions.length) * 100;
        testProgressBar.style.width = `${progress}%`;
        testQuestionCounter.textContent = `Question ${currentTestQuestionIndex + 1} of ${assessmentQuestions.length}`;
    }

    function nextTestQuestion() {
        if (currentTestQuestionIndex < assessmentQuestions.length - 1) {
            currentTestQuestionIndex++;
            renderTestQuestion();
        } else {
            showView('confirmation');
        }
    }

    function prevTestQuestion() {
        if (currentTestQuestionIndex > 0) {
            currentTestQuestionIndex--;
            renderTestQuestion();
        }
    }

    function reviewAnswers() {
        currentTestQuestionIndex = 0;
        renderTestQuestion();
        showView('test');
    }

    function submitForGrading() {
        let score = 0;
        assessmentQuestions.forEach(q => {
            const userAnswer = studentAnswers[q.id];
            if (userAnswer && userAnswer === q.correctAnswer) {
                score++;
            }
        });
        testState.score = score;
        testState.isLocked = true;
        localStorage.setItem('testState', JSON.stringify(testState));
        displayScore();
        showView('score');
    }

    function displayScore() {
        document.getElementById('final-score').textContent = `${testState.score} / ${assessmentQuestions.length}`;
    }

    function adminReset() {
        const password = prompt("Please enter admin password to reset:");
        if (password === "2026") {
            localStorage.removeItem('studentAnswers');
            localStorage.removeItem('testState');
            studentAnswers = {};
            testState = { isLocked: false, score: null };
            alert("Test has been reset.");
            window.location.reload();
        } else if (password) {
            alert("Incorrect password.");
        }
    }

    // --- PRACTICE CENTER LOGIC ---
    function startPractice() {
        currentPracticeItemIndex = 0;
        renderPracticeItem();
        showView('practice');
    }

    function renderPracticeItem() {
        const item = practiceActivities[currentPracticeItemIndex];
        const contentEl = document.getElementById('practice-content');
        let html = '';

        if (item.type === 'mc') {
            html = `<p class="text-xl mb-4">${item.question}</p><div class="space-y-2">`;
            item.options.forEach(opt => {
                html += `<label class="block p-3 border-2 rounded-lg cursor-pointer hover:bg-gray-100 border-gray-200">
                    <input type="radio" name="practice-radio" value="${escapeHTML(opt)}" class="mr-2"> ${escapeHTML(opt)}
                </label>`;
            });
            html += `</div>`;
        } else if (item.type === 'hot-text') {
            const parts = item.sentence.split(new RegExp(`(${escapeRegExp(item.answer)})`, 'i'));
            html = `<p class="text-xl mb-4">${item.instruction}</p>`;
            html += `<p class="text-2xl p-4 bg-gray-100 rounded-lg">${escapeHTML(parts[0])}<span class="hot-text-clickable p-1 hover:bg-yellow-200 rounded">${escapeHTML(parts[1])}</span>${escapeHTML(parts[2] || '')}</p>`;
        }
        
        contentEl.innerHTML = html;
        document.getElementById('practice-counter').textContent = `${currentPracticeItemIndex + 1} / ${practiceActivities.length}`;
        addPracticeListeners();
        resetPracticeButtons();
    }
    
    function addPracticeListeners() {
        const item = practiceActivities[currentPracticeItemIndex];
        if (item.type === 'hot-text') {
            document.querySelector('.hot-text-clickable').addEventListener('click', e => {
                document.querySelectorAll('.hot-text-clickable').forEach(el => el.classList.remove('hot-text-selected'));
                e.target.classList.add('hot-text-selected');
            });
        }
    }

    function checkPracticeAnswer() {
        const item = practiceActivities[currentPracticeItemIndex];
        let isCorrect = false;

        if (item.type === 'mc') {
            const selected = document.querySelector('input[name="practice-radio"]:checked');
            if (selected && selected.value === item.answer) {
                isCorrect = true;
            }
        } else if (item.type === 'hot-text') {
            const selected = document.querySelector('.hot-text-selected');
            if (selected) {
                isCorrect = true;
            }
        }

        const feedbackEl = document.getElementById('practice-feedback');
        if (isCorrect) {
            feedbackEl.textContent = 'Correct!';
            feedbackEl.className = 'mt-4 text-center text-xl font-bold h-8 text-green-600';
            document.getElementById('practice-check-btn').classList.add('hidden');
            document.getElementById('practice-next-btn').classList.remove('hidden');
            document.getElementById('practice-try-again-btn').classList.add('hidden');
            document.querySelectorAll('#practice-content input, #practice-content .hot-text-clickable').forEach(el => {
                el.style.pointerEvents = 'none';
            });
        } else {
            feedbackEl.textContent = 'Not quite, please try again.';
            feedbackEl.className = 'mt-4 text-center text-xl font-bold h-8 text-red-600';
            document.getElementById('practice-check-btn').classList.add('hidden');
            document.getElementById('practice-try-again-btn').classList.remove('hidden');
        }
    }

    function tryPracticeAgain() {
        document.getElementById('practice-feedback').textContent = '';
        document.getElementById('practice-check-btn').classList.remove('hidden');
        document.getElementById('practice-try-again-btn').classList.add('hidden');
        renderPracticeItem();
    }
    
    function resetPracticeButtons() {
        document.getElementById('practice-feedback').textContent = '';
        document.getElementById('practice-check-btn').classList.remove('hidden');
        document.getElementById('practice-next-btn').classList.add('hidden');
        document.getElementById('practice-try-again-btn').classList.add('hidden');
    }

    function nextPracticeItem() {
        if (currentPracticeItemIndex < practiceActivities.length - 1) {
            currentPracticeItemIndex++;
            renderPracticeItem();
        } else {
            alert('You have completed the practice center!');
            showView('home');
        }
    }

    // --- UTILITY & EXPORT FUNCTIONS ---
    function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function escapeHTML(str) {
        if (typeof str !== 'string') return '';
        return str.replace(/[&<>"']/g, match => ({'&': '&amp;','<': '&lt;','>': '&gt;','"': '&quot;',"'": '&#39;'})[match]);
    }

    function downloadWork() {
        const stateToSave = { answers: studentAnswers, state: testState };
        const jsonString = JSON.stringify(stateToSave);
        let currentHtml = document.documentElement.outerHTML;
        const scriptTagRegex = /<script id="progress-data" type="application\/json">.*?<\/script>/s;
        const newScriptTag = `<script id="progress-data" type="application/json">${jsonString}<\/script>`;
        currentHtml = scriptTagRegex.test(currentHtml) ? currentHtml.replace(scriptTagRegex, newScriptTag) : currentHtml.replace('</body>', `${newScriptTag}</body>`);
        const blob = new Blob([currentHtml], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'my-progress.html';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert("Your work has been downloaded as an HTML file.");
    }

    async function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const stagingArea = document.getElementById('pdf-staging-area');
        stagingArea.innerHTML = '';
        
        const loader = document.createElement('div');
        loader.innerHTML = `<div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; justify-content: center; align-items: center; color: white; font-size: 2rem;">Generating PDF...</div>`;
        document.body.appendChild(loader);

        for (let i = 0; i < assessmentQuestions.length; i++) {
            const question = assessmentQuestions[i];
            const answer = studentAnswers[question.id];
            const passageKey = i < 5 ? 'icarus' : 'arachne';
            const passage = sourceTexts[passageKey];

            const container = document.createElement('div');
            container.className = 'print-container';
            
            let passageHtml = `<div class="print-passage">
                <h4 style="font-size: 14pt; font-weight: bold; margin-bottom: 10px;">Passage: ${passage.title}</h4>
                ${passage.paragraphs.map(p => `<p style="font-size: 10pt;">${p.replace(/<strong>.*?<\/strong>/g, '')}</p>`).join('')}
            </div>`;
            
            let questionHtml = `<h3 style="margin-bottom: 10px;">Question ${i + 1}${question.part ? `, Part ${question.part}` : ''}</h3><p style="margin-bottom: 15px;">${question.stem}</p>`;
            
            switch (question.type) {
                case 'mc':
                    questionHtml += '<ul style="list-style-type: none; padding: 0;">';
                    question.options.forEach(opt => {
                        const isSelected = answer === opt;
                        questionHtml += `<li style="padding: 8px; border: 1px solid #ccc; margin-bottom: 5px; border-radius: 4px;" class="${isSelected ? 'print-answer-selected' : ''}">${escapeHTML(opt)} ${isSelected ? '<strong> (Selected)</strong>' : ''}</li>`;
                    });
                    questionHtml += '</ul>';
                    break;
                case 'hot-text':
                    const sentences = question.sentence.split(/(?<=[.?!])\s+/);
                    questionHtml += '<div style="background-color: #f9f9f9; border: 1px solid #ccc; padding: 10px;">';
                    sentences.forEach(s => {
                        const isSelected = answer === s;
                        questionHtml += `<span class="${isSelected ? 'print-hot-text-selected' : ''}">${escapeHTML(s)} </span>`;
                    });
                    questionHtml += '</div>';
                    if (answer) {
                        questionHtml += `<p style="margin-top: 10px;"><strong>Student Selected:</strong> <span class="print-answer-selected">${escapeHTML(answer)}</span></p>`;
                    } else {
                        questionHtml += `<p style="margin-top: 10px;"><em>No answer provided.</em></p>`;
                    }
                    break;
            }

            container.innerHTML = passageHtml + questionHtml;
            stagingArea.appendChild(container);

            const canvas = await html2canvas(container, { scale: 2 });
            const imgData = canvas.toDataURL('image/png');
            const imgProps = pdf.getImageProperties(imgData);
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const ratio = imgProps.width / imgProps.height;
            let imgWidth = pdfWidth - 20;
            let imgHeight = imgWidth / ratio;
            
            if (imgHeight > pdfHeight - 20) {
                imgHeight = pdfHeight - 20;
                imgWidth = imgHeight * ratio;
            }
            
            if (i > 0) pdf.addPage();
            pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
            
            stagingArea.removeChild(container);
        }

        pdf.save('two_myths_report.pdf');
        document.body.removeChild(loader);
    }
    </script>
</body>
</html>

